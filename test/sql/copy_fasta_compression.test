# name: test/sql/copy_fasta_compression.test
# description: Test COPY FORMAT FASTA with various compression options
# group: [sql]

require miint

require parquet

# Setup test data
statement ok
CREATE TABLE test_fasta_single AS SELECT sequence_index, read_id, comment, sequence1 FROM read_fastx('data/fastq/test.fa');

statement ok
CREATE TABLE test_fasta_paired AS SELECT sequence_index, read_id, comment, sequence1, sequence2 FROM read_fastx('data/fastq/small_a_r1.fq', sequence2='data/fastq/small_a_r2.fq');

# NOTE: zstd compression tests are disabled due to unicode encoding issues during read-back
# Will be re-enabled when zstd support is restored

# Test 1: Explicit COMPRESSION='gzip'
statement ok
COPY (SELECT read_id, comment, sequence1 FROM test_fasta_single ORDER BY sequence_index)
TO '__TEST_DIR__/output_explicit_gzip.fa' (FORMAT FASTA, COMPRESSION 'gzip');

query IIII
SELECT sequence_index, read_id, sequence1, comment
FROM read_fastx('__TEST_DIR__/output_explicit_gzip.fa') ORDER BY sequence_index;
----
1	seq1	ATGCATGCATGC	NULL
2	seq2	GGCCGGCCGGCC	NULL

# Test 2: Explicit COMPRESSION='gz' (alternative name)
statement ok
COPY (SELECT read_id, comment, sequence1 FROM test_fasta_single ORDER BY sequence_index)
TO '__TEST_DIR__/output_gz.fa' (FORMAT FASTA, COMPRESSION 'gz');

query III
SELECT read_id, sequence1, comment
FROM read_fastx('__TEST_DIR__/output_gz.fa') ORDER BY sequence_index;
----
seq1	ATGCATGCATGC	NULL
seq2	GGCCGGCCGGCC	NULL

# Test 3: Explicit COMPRESSION='none' (overrides .gz extension)
statement ok
COPY (SELECT read_id, comment, sequence1 FROM test_fasta_single ORDER BY sequence_index) 
TO '__TEST_DIR__/output_uncompressed.fa.gz' (FORMAT FASTA, COMPRESSION 'none');

query IIII
SELECT sequence_index, read_id, sequence1, comment 
FROM read_fastx('__TEST_DIR__/output_uncompressed.fa.gz') ORDER BY sequence_index;
----
1	seq1	ATGCATGCATGC	NULL
2	seq2	GGCCGGCCGGCC	NULL

# Test 4: Verify gzip backward compatibility (existing .gz auto-detect still works)
statement ok
COPY (SELECT read_id, comment, sequence1 FROM test_fasta_single ORDER BY sequence_index) 
TO '__TEST_DIR__/backward_compat.fa.gz' (FORMAT FASTA);

query IIII
SELECT sequence_index, read_id, sequence1, comment 
FROM read_fastx('__TEST_DIR__/backward_compat.fa.gz') ORDER BY sequence_index;
----
1	seq1	ATGCATGCATGC	NULL
2	seq2	GGCCGGCCGGCC	NULL

# Cleanup
statement ok
DROP TABLE test_fasta_single;

statement ok
DROP TABLE test_fasta_paired;
