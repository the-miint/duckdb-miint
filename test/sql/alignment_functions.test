# name: test/sql/alignment_functions.test
# description: test alignment_seq_identity scalar function
# group: [sql]

require miint

###############################################################################
# STOP_POSITION TESTS (from read_sam schema)
###############################################################################

# Verify stop_position is computed correctly
query III
SELECT position, stop_position, cigar FROM read_sam('data/sam/foo_has_header.sam') WHERE read_id = 'foo-1';
----
2	12	10M

# Verify stop_position for larger alignments
query III
SELECT position, stop_position, cigar FROM read_sam('data/sam/foo_has_header.sam') WHERE read_id = 'foo-3' LIMIT 1;
----
76020	76170	150M

###############################################################################
# ALIGNMENT_SEQ_IDENTITY - BASIC FUNCTIONALITY
###############################################################################

# Test gap_compressed mode (default) with simple CIGAR
query R
SELECT alignment_seq_identity('10M', 0, '', 'gap_compressed')::FLOAT;
----
1.0

# Test gap_compressed with some mismatches (NM=2)
query R
SELECT alignment_seq_identity('10M', 2, '', 'gap_compressed')::FLOAT;
----
0.8

# Test gap_compressed with insertions
# CIGAR: 10M5I10M, NM=5 (5 insertions)
# m=20, n=5, g=5, o=1
# (m - n + g) / (m + o) = (20 - 5 + 5) / (20 + 1) = 20/21 ≈ 0.952
query R
SELECT alignment_seq_identity('10M5I10M', 5, '', 'gap_compressed')::FLOAT;
----
0.952

# Test gap_compressed with deletions
# CIGAR: 10M3D10M, NM=3 (3 deletions)
# m=20, n=3, g=3, o=1
# (m - n + g) / (m + o) = (20 - 3 + 3) / (20 + 1) = 20/21 ≈ 0.952
query R
SELECT alignment_seq_identity('10M3D10M', 3, '', 'gap_compressed')::FLOAT;
----
0.952

# Test blast mode
# CIGAR: 10M, NM=2
# alignment_columns=10, matches=10-2=8
# 8/10 = 0.8
query R
SELECT alignment_seq_identity('10M', 2, '', 'blast')::FLOAT;
----
0.8

# Test blast mode with indels
# CIGAR: 10M5I5D, NM=12 (2 mismatches + 5 ins + 5 del)
# alignment_columns=20, matches=20-12=8
# 8/20 = 0.4
query R
SELECT alignment_seq_identity('10M5I5D', 12, '', 'blast')::FLOAT;
----
0.4

# Test gap_excluded mode
# MD: 10 (10 matches, 0 mismatches)
query R
SELECT alignment_seq_identity('10M', -1, '10', 'gap_excluded')::FLOAT;
----
1.0

# Test gap_excluded with mismatches
# MD: 5A4 (5 matches, 1 mismatch 'A', 4 matches)
query R
SELECT alignment_seq_identity('10M', -1, '5A4', 'gap_excluded')::FLOAT;
----
0.9

# Test gap_excluded with multiple mismatches
# MD: 3A2T3 (3 matches, mismatch 'A', 2 matches, mismatch 'T', 3 matches)
query R
SELECT alignment_seq_identity('10M', -1, '3A2T3', 'gap_excluded')::FLOAT;
----
0.8

# Test gap_excluded with deletions in MD
# MD: 5^AC4 (5 matches, deletion of 'AC', 4 matches)
query R
SELECT alignment_seq_identity('5M2D4M', -1, '5^AC4', 'gap_excluded')::FLOAT;
----
1.0

# Test correctness against Heng Li's blog post 
# https://lh3.github.io/2018/11/25/on-the-definition-of-sequence-identity
query R
SELECT alignment_seq_identity('18M3D2M2D2M1I22M', NULL, '14A3^CAG2^TG24', 'gap_excluded')::FLOAT;
----
0.977

query R
SELECT alignment_seq_identity('18M3D2M2D2M1I22M', 7, NULL, 'blast')::FLOAT;
----
0.86

query R
SELECT alignment_seq_identity('18M3D2M2D2M1I22M', 7, NULL, 'gap_compressed')::FLOAT;
----
0.915

###############################################################################
# NULL HANDLING
###############################################################################

# NULL CIGAR should return NULL
query I
SELECT alignment_seq_identity(NULL, 0, '', 'gap_compressed') IS NULL;
----
true

# Unmapped read (CIGAR='*') should return NULL
query I
SELECT alignment_seq_identity('*', 0, '', 'gap_compressed') IS NULL;
----
true

# Missing NM tag (nm=-1) for blast mode should return NULL
query I
SELECT alignment_seq_identity('10M', -1, '', 'blast') IS NULL;
----
true

# Missing NM tag (nm=-1) for gap_compressed mode should return NULL
query I
SELECT alignment_seq_identity('10M', -1, '', 'gap_compressed') IS NULL;
----
true

# Missing MD tag for gap_excluded mode should return NULL
query I
SELECT alignment_seq_identity('10M', 0, '', 'gap_excluded') IS NULL;
----
true

# NULL MD tag for gap_excluded mode should return NULL
query I
SELECT alignment_seq_identity('10M', 0, NULL, 'gap_excluded') IS NULL;
----
true

# NULL NM tag for gap_excluded mode should work (NM not needed)
query R
SELECT alignment_seq_identity('10M', NULL, '5A4', 'gap_excluded')::FLOAT;
----
0.9

# NULL MD tag for blast mode should work (MD not needed)
query R
SELECT alignment_seq_identity('10M', 2, NULL, 'blast')::FLOAT;
----
0.8

# NULL NM tag for blast mode should return NULL
query I
SELECT alignment_seq_identity('10M', NULL, '', 'blast') IS NULL;
----
true

# NULL NM tag for gap_compressed mode should return NULL
query I
SELECT alignment_seq_identity('10M', NULL, '', 'gap_compressed') IS NULL;
----
true

# NULL type parameter should return NULL
query I
SELECT alignment_seq_identity('10M', 0, '', NULL) IS NULL;
----
true

# All parameters NULL except CIGAR
query I
SELECT alignment_seq_identity('10M', NULL, NULL, NULL) IS NULL;
----
true

# All parameters NULL
query I
SELECT alignment_seq_identity(NULL, NULL, NULL, NULL) IS NULL;
----
true

###############################################################################
# ERROR HANDLING
###############################################################################

# Invalid type parameter
statement error
SELECT alignment_seq_identity('10M', 0, '', 'invalid_type');
----
Invalid Input Error: Invalid type parameter for alignment_seq_identity

###############################################################################
# COMPLEX CIGAR PATTERNS
###############################################################################

# CIGAR with soft clipping (should be ignored)
# 5S10M5S, NM=1
query R
SELECT alignment_seq_identity('5S10M5S', 1, '', 'gap_compressed')::FLOAT;
----
0.9

# CIGAR with hard clipping (should be ignored)
# 5H10M5H, NM=0
query R
SELECT alignment_seq_identity('5H10M5H', 0, '', 'gap_compressed')::FLOAT;
----
1.0

# CIGAR with ref skip (N operation, e.g., spliced alignment)
# 10M100N10M, NM=2
query R
SELECT alignment_seq_identity('10M100N10M', 2, '', 'gap_compressed')::FLOAT;
----
0.9

# Multiple gap opens
# CIGAR: 10M2I5M3D5M, NM=7 (2 ins + 3 del + 2 mismatches)
# m=20, n=7, g=5, o=2
# (m - n + g) / (m + o) = (20 - 7 + 5) / (20 + 2) = 18/22 ≈ 0.818
query R
SELECT alignment_seq_identity('10M2I5M3D5M', 7, '', 'gap_compressed')::FLOAT;
----
0.818

# Test = and X CIGAR operations (explicit match/mismatch)
# CIGAR: 5=2X3=, NM=2
query R
SELECT alignment_seq_identity('5=2X3=', 2, '', 'gap_compressed')::FLOAT;
----
0.8

###############################################################################
# INTEGRATION WITH read_sam
###############################################################################

# Test with actual SAM data - verify we can call function on read_sam output
query I
SELECT COUNT(*) FROM read_sam('data/sam/foo_has_header.sam') 
WHERE alignment_seq_identity(cigar, tag_nm, tag_md, 'gap_compressed') IS NOT NULL;
----
0

# Verify function works with all three modes on SAM data
query I
SELECT COUNT(*) FROM read_sam('data/sam/foo_has_header.sam') 
WHERE alignment_seq_identity(cigar, tag_nm, tag_md, 'blast') IS NULL;
----
4

query I
SELECT COUNT(*) FROM read_sam('data/sam/foo_has_header.sam')
WHERE alignment_seq_identity(cigar, tag_nm, tag_md, 'gap_excluded') IS NULL;
----
4

###############################################################################
# ALIGNMENT_QUERY_LENGTH - BASIC FUNCTIONALITY
###############################################################################

# Simple match - no clipping
query I
SELECT alignment_query_length('10M', true);
----
10

# Match with default parameter (include_hard_clips defaults to true)
query I
SELECT alignment_query_length('10M');
----
10

# Match with insertions
query I
SELECT alignment_query_length('10M5I', true);
----
15

# Match with deletions (deletions don't consume query)
query I
SELECT alignment_query_length('10M5D', true);
----
10

# With soft clips only
query I
SELECT alignment_query_length('5S10M5S', true);
----
20

# With hard clips - include them
query I
SELECT alignment_query_length('5H10M5H', true);
----
20

# With hard clips - exclude them
query I
SELECT alignment_query_length('5H10M5H', false);
----
10

# With both soft and hard clips - include hard clips
query I
SELECT alignment_query_length('5H5S10M5S5H', true);
----
30

# With both soft and hard clips - exclude hard clips
query I
SELECT alignment_query_length('5H5S10M5S5H', false);
----
20

# Complex CIGAR with all operations
query I
SELECT alignment_query_length('5H5S10M5I3D5M5S5H', true);
----
40

# Complex CIGAR - exclude hard clips
query I
SELECT alignment_query_length('5H5S10M5I3D5M5S5H', false);
----
30

###############################################################################
# ALIGNMENT_QUERY_LENGTH - VERIFY MATCHES bam_cigar2qlen BEHAVIOR
###############################################################################

# When include_hard_clips=false, should match bam_cigar2qlen
# bam_cigar2qlen counts M, I, S, =, X operations (excludes H, D, N, P)

# HTSlib example 1: 10M5I5S
query I
SELECT alignment_query_length('10M5I5S', false);
----
20

# HTSlib example 2: 5S10M3D5M5S
query I
SELECT alignment_query_length('5S10M3D5M5S', false);
----
25

# HTSlib example 3: 5H10M5H (hard clips excluded)
query I
SELECT alignment_query_length('5H10M5H', false);
----
10

# HTSlib example 4: 5=2X3= (explicit match/mismatch)
query I
SELECT alignment_query_length('5=2X3=', false);
----
10

# HTSlib example 5: 18M3D2M2D2M1I22M (complex with deletions)
query I
SELECT alignment_query_length('18M3D2M2D2M1I22M', false);
----
45

###############################################################################
# ALIGNMENT_QUERY_LENGTH - EDGE CASES
###############################################################################

# Empty string CIGAR
query I
SELECT alignment_query_length('', true);
----
0

# Unmapped read (*)
query I
SELECT alignment_query_length('*', true);
----
0

# Only soft clipping
query I
SELECT alignment_query_length('100S', true);
----
100

# Only hard clipping - included
query I
SELECT alignment_query_length('100H', true);
----
100

# Only hard clipping - excluded
query I
SELECT alignment_query_length('100H', false);
----
0

# Reference skip (N) doesn't consume query
query I
SELECT alignment_query_length('10M100N10M', true);
----
20

###############################################################################
# ALIGNMENT_QUERY_LENGTH - NULL HANDLING
###############################################################################

# NULL CIGAR should return NULL
query I
SELECT alignment_query_length(NULL, true) IS NULL;
----
true

# NULL with default parameter
query I
SELECT alignment_query_length(NULL) IS NULL;
----
true

# NULL for include_hard_clips parameter returns NULL (not default)
# Note: Explicitly passing NULL is different from omitting the parameter
query I
SELECT alignment_query_length('5H10M5H', NULL) IS NULL;
----
true

###############################################################################
# ALIGNMENT_QUERY_COVERAGE - ALIGNED TYPE
###############################################################################

# Perfect alignment - no clipping
query R
SELECT alignment_query_coverage('10M', 'aligned')::FLOAT;
----
1.0

# Default parameter (type defaults to 'aligned')
query R
SELECT alignment_query_coverage('10M')::FLOAT;
----
1.0

# Alignment with insertions
# 10 aligned / 15 total = 0.6667
query R
SELECT alignment_query_coverage('10M5I', 'aligned')::FLOAT;
----
0.667

# Alignment with soft clips
# 10 aligned / 20 total = 0.5
query R
SELECT alignment_query_coverage('5S10M5S', 'aligned')::FLOAT;
----
0.5

# Alignment with hard clips
# 10 aligned / 20 total = 0.5
query R
SELECT alignment_query_coverage('5H10M5H', 'aligned')::FLOAT;
----
0.5

# Alignment with both soft and hard clips
# 10 aligned / 30 total = 0.3333
query R
SELECT alignment_query_coverage('5H5S10M5S5H', 'aligned')::FLOAT;
----
0.333

# Complex alignment with insertions and clips
# 10 aligned / 35 total = 0.2857
query R
SELECT alignment_query_coverage('5H5S10M5I5S5H', 'aligned')::FLOAT;
----
0.286

# Only soft clips - zero coverage
query R
SELECT alignment_query_coverage('100S', 'aligned')::FLOAT;
----
0.0

# Only hard clips - zero coverage
query R
SELECT alignment_query_coverage('100H', 'aligned')::FLOAT;
----
0.0

###############################################################################
# ALIGNMENT_QUERY_COVERAGE - MAPPED TYPE
###############################################################################

# Perfect alignment - no clipping
query R
SELECT alignment_query_coverage('10M', 'mapped')::FLOAT;
----
1.0

# Alignment with insertions
# 15 mapped (M+I) / 15 total = 1.0
query R
SELECT alignment_query_coverage('10M5I', 'mapped')::FLOAT;
----
1.0

# Alignment with soft clips
# 10 mapped / 20 total = 0.5
query R
SELECT alignment_query_coverage('5S10M5S', 'mapped')::FLOAT;
----
0.5

# Alignment with hard clips
# 10 mapped / 20 total = 0.5
query R
SELECT alignment_query_coverage('5H10M5H', 'mapped')::FLOAT;
----
0.5

# Alignment with insertions and soft clips
# 15 mapped (M+I) / 25 total = 0.6
query R
SELECT alignment_query_coverage('5S10M5I5S', 'mapped')::FLOAT;
----
0.6

# Complex alignment with all operations
# 15 mapped (M+I) / 35 total = 0.4286
query R
SELECT alignment_query_coverage('5H5S10M5I5S5H', 'mapped')::FLOAT;
----
0.429

# Only soft clips - zero coverage
query R
SELECT alignment_query_coverage('100S', 'mapped')::FLOAT;
----
0.0

# Only hard clips - zero coverage
query R
SELECT alignment_query_coverage('100H', 'mapped')::FLOAT;
----
0.0

###############################################################################
# ALIGNMENT_QUERY_COVERAGE - EDGE CASES
###############################################################################

# Empty CIGAR - zero coverage (not NULL)
query R
SELECT alignment_query_coverage('', 'aligned')::FLOAT;
----
0.0

# Unmapped read (*) - zero coverage
query R
SELECT alignment_query_coverage('*', 'aligned')::FLOAT;
----
0.0

# Deletions don't affect coverage calculation
# 20 aligned / 20 total = 1.0
query R
SELECT alignment_query_coverage('10M5D10M', 'aligned')::FLOAT;
----
1.0

# Reference skip (N) doesn't affect coverage
# 20 aligned / 20 total = 1.0
query R
SELECT alignment_query_coverage('10M100N10M', 'aligned')::FLOAT;
----
1.0

# Verify deletions don't affect mapped coverage either
query R
SELECT alignment_query_coverage('10M5D10M', 'mapped')::FLOAT;
----
1.0

###############################################################################
# ALIGNMENT_QUERY_COVERAGE - NULL HANDLING
###############################################################################

# NULL CIGAR should return NULL
query I
SELECT alignment_query_coverage(NULL, 'aligned') IS NULL;
----
true

# NULL with default parameter
query I
SELECT alignment_query_coverage(NULL) IS NULL;
----
true

# NULL type parameter should return NULL
query I
SELECT alignment_query_coverage('10M', NULL) IS NULL;
----
true

# Both NULL
query I
SELECT alignment_query_coverage(NULL, NULL) IS NULL;
----
true

###############################################################################
# ALIGNMENT_QUERY_COVERAGE - ERROR HANDLING
###############################################################################

# Invalid type parameter
statement error
SELECT alignment_query_coverage('10M', 'invalid_type');
----
Invalid Input Error: Invalid coverage type

###############################################################################
# ALIGNMENT_QUERY_COVERAGE - ALIGNED VS MAPPED COMPARISON
###############################################################################

# Insertions increase mapped coverage but not aligned
# aligned: 10 / 40 = 0.25
# mapped: 20 / 40 = 0.5
query RR
SELECT
    alignment_query_coverage('10H10M10I10H', 'aligned')::FLOAT,
    alignment_query_coverage('10H10M10I10H', 'mapped')::FLOAT;
----
0.25	0.5

# Without insertions, aligned == mapped
query RR
SELECT
    alignment_query_coverage('5H5S10M5S5H', 'aligned')::FLOAT,
    alignment_query_coverage('5H5S10M5S5H', 'mapped')::FLOAT;
----
0.333	0.333

###############################################################################
# INTEGRATION WITH read_sam
###############################################################################

# Test with actual SAM data - verify functions work on real data
query I
SELECT COUNT(*) FROM read_sam('data/sam/foo_has_header.sam')
WHERE alignment_query_length(cigar, true) > 0;
----
4

# Verify coverage function works with SAM data
query I
SELECT COUNT(*) FROM read_sam('data/sam/foo_has_header.sam')
WHERE alignment_query_coverage(cigar, 'aligned') >= 0.0;
----
4

###############################################################################
# ERROR HANDLING - INVALID CIGAR STRINGS
###############################################################################

# Invalid CIGAR - operation without length
statement error
SELECT alignment_query_length('M');
----
Invalid CIGAR string: operation without length

# Invalid CIGAR - unknown operation character
statement error
SELECT alignment_query_length('10Z');
----
Invalid CIGAR operation: Z

# Invalid CIGAR - incomplete (number without operation)
statement error
SELECT alignment_query_length('10M5');
----
Invalid CIGAR string: incomplete operation (missing operation character)

# Test same errors with alignment_query_coverage
statement error
SELECT alignment_query_coverage('M', 'aligned');
----
Invalid CIGAR string: operation without length

statement error
SELECT alignment_query_coverage('10Z', 'aligned');
----
Invalid CIGAR operation: Z

# Note: alignment_seq_identity returns NULL for invalid CIGAR instead of throwing
# This is intentional - it processes batches and needs to handle errors gracefully
query I
SELECT alignment_seq_identity('10Z', 0, '', 'blast') IS NULL;
----
true

###############################################################################
# ERROR HANDLING - INTEGER OVERFLOW
###############################################################################

# CIGAR with huge number that would overflow int64
statement error
SELECT alignment_query_length('999999999999999999999M');
----
CIGAR operation length exceeds maximum

# MD tag with huge number - alignment_seq_identity returns NULL (doesn't throw)
query I
SELECT alignment_seq_identity('10M', 0, '999999999999999999999', 'gap_excluded') IS NULL;
----
true

###############################################################################
# ERROR HANDLING - INVALID NM TAG VALUES
###############################################################################

# NM tag exceeds alignment length (blast mode) - returns NULL
query I
SELECT alignment_seq_identity('10M', 20, '', 'blast') IS NULL;
----
true

# NM tag exceeds matches+gaps (gap_compressed mode) - returns NULL
query I
SELECT alignment_seq_identity('10M', 20, '', 'gap_compressed') IS NULL;
----
true
