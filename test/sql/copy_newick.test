# name: test/sql/copy_newick.test
# description: Test COPY ... FORMAT NEWICK for writing Newick tree files
# group: [sql]

require miint

# =============================================================================
# Basic roundtrip test
# =============================================================================

# Create table from parsed newick
statement ok
CREATE TABLE tree1 AS SELECT * FROM parse_newick('data/newick/simple.nwk');

# Copy to new file
statement ok
COPY tree1 TO '__TEST_DIR__/tree1_out.nwk' (FORMAT NEWICK);

# Parse the output and verify structure
query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/tree1_out.nwk');
----
5

# Verify tip names preserved
query T
SELECT name FROM parse_newick('__TEST_DIR__/tree1_out.nwk') WHERE is_tip = true ORDER BY name;
----
A
B
C

# Verify branch lengths preserved (with tolerance for floating point)
query TR
SELECT name, ROUND(branch_length, 2) FROM parse_newick('__TEST_DIR__/tree1_out.nwk')
WHERE is_tip = true ORDER BY name;
----
A	0.1
B	0.2
C	0.4

statement ok
DROP TABLE tree1;

# =============================================================================
# Edge IDs support
# =============================================================================

statement ok
CREATE TABLE tree_edges AS SELECT * FROM parse_newick('data/newick/with_edge_ids.nwk');

# Copy with edge IDs enabled
statement ok
COPY tree_edges TO '__TEST_DIR__/tree_edges_out.nwk' (FORMAT NEWICK, EDGE_IDS true);

# Verify edge IDs are present in output
query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/tree_edges_out.nwk') WHERE edge_id IS NOT NULL;
----
5

# Copy without edge IDs
statement ok
COPY tree_edges TO '__TEST_DIR__/tree_no_edges_out.nwk' (FORMAT NEWICK, EDGE_IDS false);

# Verify no edge IDs in output
query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/tree_no_edges_out.nwk') WHERE edge_id IS NOT NULL;
----
0

statement ok
DROP TABLE tree_edges;

# =============================================================================
# Default EDGE_IDS behavior
# =============================================================================

# When input has edge_ids, default should preserve them
statement ok
CREATE TABLE tree_default AS SELECT * FROM parse_newick('data/newick/with_edge_ids.nwk');

statement ok
COPY tree_default TO '__TEST_DIR__/tree_default_out.nwk' (FORMAT NEWICK);

query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/tree_default_out.nwk') WHERE edge_id IS NOT NULL;
----
5

statement ok
DROP TABLE tree_default;

# =============================================================================
# Compression support
# =============================================================================

statement ok
CREATE TABLE tree_compress AS SELECT * FROM parse_newick('data/newick/simple.nwk');

# Test gzip compression
statement ok
COPY tree_compress TO '__TEST_DIR__/tree_compress.nwk.gz' (FORMAT NEWICK, COMPRESSION 'gzip');

# Read back compressed file
query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/tree_compress.nwk.gz');
----
5

# Test explicit no compression
statement ok
COPY tree_compress TO '__TEST_DIR__/tree_nocompress.nwk' (FORMAT NEWICK, COMPRESSION 'none');

query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/tree_nocompress.nwk');
----
5

statement ok
DROP TABLE tree_compress;

# =============================================================================
# Required columns validation
# =============================================================================

# Missing node_index should error
statement ok
CREATE TABLE missing_node_index AS
SELECT name, branch_length, parent_index FROM parse_newick('data/newick/simple.nwk');

statement error
COPY missing_node_index TO '__TEST_DIR__/missing.nwk' (FORMAT NEWICK);
----
node_index

statement ok
DROP TABLE missing_node_index;

# Missing parent_index should error
statement ok
CREATE TABLE missing_parent AS
SELECT node_index, name, branch_length FROM parse_newick('data/newick/simple.nwk');

statement error
COPY missing_parent TO '__TEST_DIR__/missing.nwk' (FORMAT NEWICK);
----
parent_index

statement ok
DROP TABLE missing_parent;

# =============================================================================
# Tree structure validation
# =============================================================================

# No root (all nodes have parents) should error
statement ok
CREATE TABLE no_root AS
SELECT node_index, name, branch_length, 0::BIGINT AS parent_index FROM parse_newick('data/newick/simple.nwk');

statement error
COPY no_root TO '__TEST_DIR__/noroot.nwk' (FORMAT NEWICK);
----
root

statement ok
DROP TABLE no_root;

# Multiple roots should error
statement ok
CREATE TABLE multi_root AS
SELECT node_index, name, branch_length, NULL::BIGINT AS parent_index FROM parse_newick('data/newick/simple.nwk');

statement error
COPY multi_root TO '__TEST_DIR__/multiroot.nwk' (FORMAT NEWICK);
----
root

statement ok
DROP TABLE multi_root;

# =============================================================================
# Optional columns
# =============================================================================

# name is optional (internal nodes often unnamed)
statement ok
CREATE TABLE no_names AS
SELECT node_index, NULL::VARCHAR AS name, branch_length, parent_index FROM parse_newick('data/newick/simple.nwk');

statement ok
COPY no_names TO '__TEST_DIR__/no_names.nwk' (FORMAT NEWICK);

query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/no_names.nwk');
----
5

statement ok
DROP TABLE no_names;

# branch_length is optional
statement ok
CREATE TABLE no_lengths AS
SELECT node_index, name, NULL::DOUBLE AS branch_length, parent_index FROM parse_newick('data/newick/simple.nwk');

statement ok
COPY no_lengths TO '__TEST_DIR__/no_lengths.nwk' (FORMAT NEWICK);

query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/no_lengths.nwk') WHERE branch_length IS NULL;
----
5

statement ok
DROP TABLE no_lengths;

# edge_id is optional
statement ok
CREATE TABLE no_edge_ids AS
SELECT node_index, name, branch_length, parent_index FROM parse_newick('data/newick/simple.nwk');

statement ok
COPY no_edge_ids TO '__TEST_DIR__/no_edge_ids.nwk' (FORMAT NEWICK);

query I
SELECT COUNT(*) FROM parse_newick('__TEST_DIR__/no_edge_ids.nwk');
----
5

statement ok
DROP TABLE no_edge_ids;

# =============================================================================
# Unknown option error
# =============================================================================

statement ok
CREATE TABLE tree_opt AS SELECT * FROM parse_newick('data/newick/simple.nwk');

statement error
COPY tree_opt TO '__TEST_DIR__/opt.nwk' (FORMAT NEWICK, UNKNOWN_OPT true);
----
Unknown option

statement ok
DROP TABLE tree_opt;

# =============================================================================
# Complete roundtrip with all features
# =============================================================================

statement ok
CREATE TABLE full_tree AS SELECT * FROM parse_newick('data/newick/with_edge_ids.nwk');

# Export with all features
statement ok
COPY full_tree TO '__TEST_DIR__/full_roundtrip.nwk.gz' (FORMAT NEWICK, EDGE_IDS true, COMPRESSION 'gzip');

# Import and compare
statement ok
CREATE TABLE reimported AS SELECT * FROM parse_newick('__TEST_DIR__/full_roundtrip.nwk.gz');

# Same node count
query II
SELECT
    (SELECT COUNT(*) FROM full_tree) AS original,
    (SELECT COUNT(*) FROM reimported) AS reimported;
----
5	5

# Same tip count
query II
SELECT
    (SELECT COUNT(*) FROM full_tree WHERE is_tip = true) AS original,
    (SELECT COUNT(*) FROM reimported WHERE is_tip = true) AS reimported;
----
3	3

# Same tip names
query I
SELECT COUNT(*) FROM (
    SELECT name FROM full_tree WHERE is_tip = true
    EXCEPT
    SELECT name FROM reimported WHERE is_tip = true
);
----
0

# Same edge IDs present
query II
SELECT
    (SELECT COUNT(*) FROM full_tree WHERE edge_id IS NOT NULL) AS original,
    (SELECT COUNT(*) FROM reimported WHERE edge_id IS NOT NULL) AS reimported;
----
5	5

statement ok
DROP TABLE full_tree;

statement ok
DROP TABLE reimported;

# =============================================================================
# Compression roundtrip with branch length verification
# =============================================================================

statement ok
CREATE TABLE compress_verify AS SELECT * FROM parse_newick('data/newick/simple.nwk');

statement ok
COPY compress_verify TO '__TEST_DIR__/compress_verify.nwk.gz' (FORMAT NEWICK, COMPRESSION 'gzip');

statement ok
CREATE TABLE compress_reimported AS SELECT * FROM parse_newick('__TEST_DIR__/compress_verify.nwk.gz');

# Verify branch lengths match (within tolerance)
query I
SELECT COUNT(*) FROM (
    SELECT node_index, name, ROUND(branch_length, 6) AS bl FROM compress_verify WHERE is_tip = true
    EXCEPT
    SELECT node_index, name, ROUND(branch_length, 6) AS bl FROM compress_reimported WHERE is_tip = true
);
----
0

statement ok
DROP TABLE compress_verify;

statement ok
DROP TABLE compress_reimported;

# =============================================================================
# Negative branch length validation
# =============================================================================

statement ok
CREATE TABLE negative_bl AS
SELECT node_index, name, CAST(-0.1 AS DOUBLE) AS branch_length, parent_index FROM parse_newick('data/newick/simple.nwk');

statement error
COPY negative_bl TO '__TEST_DIR__/negative.nwk' (FORMAT NEWICK);
----
Negative branch_length

statement ok
DROP TABLE negative_bl;
