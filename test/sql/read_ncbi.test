# name: test/sql/read_ncbi.test
# description: Test read_ncbi table function
# group: [sql]

# NOTE: This test requires network access to NCBI servers
# Tests are structured to minimize NCBI requests by fetching data once into temp tables

require miint

# httpfs is auto-loaded by the miint extension

# Test error: empty accession
statement error
SELECT * FROM read_ncbi('');
----
accession cannot be empty

# Test error: empty array
statement error
SELECT * FROM read_ncbi([]);
----
at least one accession must be provided

# Test error: assembly accession (GCF_/GCA_) not supported
statement error
SELECT * FROM read_ncbi('GCF_000005845.2');
----
Assembly accession

# Test schema
query IIIIII
DESCRIBE SELECT * FROM read_ncbi('NC_001416.1');
----
accession	VARCHAR	YES	NULL	NULL	NULL
version	INTEGER	YES	NULL	NULL	NULL
description	VARCHAR	YES	NULL	NULL	NULL
organism	VARCHAR	YES	NULL	NULL	NULL
taxonomy_id	BIGINT	YES	NULL	NULL	NULL
length	BIGINT	YES	NULL	NULL	NULL
molecule_type	VARCHAR	YES	NULL	NULL	NULL
update_date	DATE	YES	NULL	NULL	NULL

# Fetch Lambda phage metadata once, reuse for multiple tests
statement ok
CREATE TEMP TABLE lambda_meta AS
SELECT * FROM read_ncbi('NC_001416.1');

# Test basic fetch - Lambda phage
query IIIII
SELECT accession, version, length, molecule_type, taxonomy_id > 0 AS has_taxid
FROM lambda_meta;
----
NC_001416.1	1	48502	DNA	true

# Test description contains expected text
query I
SELECT description LIKE '%lambda%' OR description LIKE '%Lambda%' AS has_lambda
FROM lambda_meta;
----
true

# Test organism is populated
query I
SELECT organism LIKE '%phage%' OR organism LIKE '%Phage%' AS has_phage
FROM lambda_meta;
----
true

# Test update_date is a valid date
query I
SELECT update_date IS NOT NULL AND update_date > '2000-01-01'::DATE AS valid_date
FROM lambda_meta;
----
true

# Fetch multiple accessions once, reuse for tests
statement ok
CREATE TEMP TABLE multi_meta AS
SELECT * FROM read_ncbi(['NC_001416.1', 'NC_001422.1']);

# Test multiple accessions
query III
SELECT accession, length, version
FROM multi_meta
ORDER BY accession;
----
NC_001416.1	48502	1
NC_001422.1	5386	1

# Test COUNT works correctly
query I
SELECT COUNT(*) FROM multi_meta;
----
2

# Test with PhiX174 bacteriophage (NC_001422.1)
query II
SELECT accession, molecule_type
FROM multi_meta
WHERE accession = 'NC_001422.1';
----
NC_001422.1	DNA
