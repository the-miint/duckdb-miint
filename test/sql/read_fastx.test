# name: test/sql/read_fastx.test
# description: test read_fastx table function
# group: [sql]

statement ok
PRAGMA enable_verification;

# Before we load the extension, this will fail
statement error
SELECT * FROM read_fastx('foo', 'bar');
----
Catalog Error: Table Function with name read_fastx does not exist!

# Require statement will ensure this test is run with this extension loaded
require miint

# Confirm the extension fails when files are not found
statement error
SELECT * FROM read_fastx('missing_file1', sequence2='missing_file2');
----
IO Error: File not found: missing_file1

query IIIIIII
SELECT * FROM read_fastx('data/fastq/foo.r1.fastq.gz', sequence2='data/fastq/foo.r2.fastq.gz')
----
1	foo1	comment-1	ATGC	TGCAT	[40, 39, 38, 37]	[36, 35, 34, 33, 32]
2	foo2	comment-2	ATGCT	TGCATC	[40, 39, 38, 37, 36]	[36, 35, 34, 33, 32, 31]

query IIIIIII
SELECT * FROM read_fastx('data/fastq/bar.r1.fastq.gz', sequence2='data/fastq/bar.r2.fastq.gz')
----
1	bar1	NULL	AA	CCC	[40, 40]	[39, 39, 39]
2	bar2	NULL	GG	GGG	[40, 40]	[39, 39, 39]
3	bar3	NULL	TT	TTT	[40, 40]	[39, 39, 39]

# mismatched read IDs
statement error
SELECT * FROM read_fastx('data/fastq/foo.r1.fastq.gz', sequence2='data/fastq/foo.r2.fastq.mismatched-ids.fastq.gz')
----
Invalid Error: Mismatched read IDs: foo1/1 vs foo2/2

# different number of reads
statement error
SELECT * FROM read_fastx('data/fastq/foo.r1.fastq.gz', sequence2='data/fastq/foo.r2.fastq.missing-read.fastq.gz')
----
Invalid Error: Mismatched number of records: missing mate for foo2/1

# single end
query IIIIIII
SELECT * FROM read_fastx('data/fastq/foo.r1.fastq.gz')
----
1	foo1	comment-1	ATGC	NULL	[40, 39, 38, 37]	NULL
2	foo2	comment-2	ATGCT	NULL	[40, 39, 38, 37, 36]	NULL

# interleaved
# alternative phred offset
#statement error
#select * from read_fastx('fail-missing-tests');

# ===== NEW TESTS FOR EXPANDED FUNCTIONALITY =====

# Test FASTA format (no quality scores - should be NULL)
query IIIIIII
SELECT * FROM read_fastx('data/fastq/test.fa')
----
1	seq1	test sequence 1	ATGCATGCATGC	NULL	NULL	NULL
2	seq2	NULL	GGCCGGCCGGCC	NULL	NULL	NULL

# Test VARCHAR[] single-end (multiple files concatenated)
query IIIIIII
SELECT * FROM read_fastx(['data/fastq/small_a.fq', 'data/fastq/small_b.fq'])
----
1	read_a1	NULL	AAAA	NULL	[40, 40, 40, 40]	NULL
2	read_a2	NULL	TTTT	NULL	[39, 39, 39, 39]	NULL
3	read_b1	NULL	GGGG	NULL	[38, 38, 38, 38]	NULL
4	read_b2	NULL	CCCC	NULL	[37, 37, 37, 37]	NULL

# Test VARCHAR[] paired-end
query IIIIIII
SELECT * FROM read_fastx(['data/fastq/small_a_r1.fq', 'data/fastq/small_b_r1.fq'], 
                          sequence2=['data/fastq/small_a_r2.fq', 'data/fastq/small_b_r2.fq'])
----
1	pair_a1	NULL	AAAA	TTTT	[40, 40, 40, 40]	[39, 39, 39, 39]
2	pair_b1	NULL	GGGG	CCCC	[38, 38, 38, 38]	[37, 37, 37, 37]

# Test include_filepath parameter
query IIIIIIII
SELECT * FROM read_fastx(['data/fastq/small_a.fq', 'data/fastq/small_b.fq'], include_filepath=true)
----
1	read_a1	NULL	AAAA	NULL	[40, 40, 40, 40]	NULL	data/fastq/small_a.fq
2	read_a2	NULL	TTTT	NULL	[39, 39, 39, 39]	NULL	data/fastq/small_a.fq
3	read_b1	NULL	GGGG	NULL	[38, 38, 38, 38]	NULL	data/fastq/small_b.fq
4	read_b2	NULL	CCCC	NULL	[37, 37, 37, 37]	NULL	data/fastq/small_b.fq

# Test include_filepath with paired-end
query IIIIIIII
SELECT * FROM read_fastx('data/fastq/small_a_r1.fq', 
                          sequence2='data/fastq/small_a_r2.fq',
                          include_filepath=true)
----
1	pair_a1	NULL	AAAA	TTTT	[40, 40, 40, 40]	[39, 39, 39, 39]	data/fastq/small_a_r1.fq

# Test COUNT with VARCHAR[] to verify all records read
query I
SELECT COUNT(*) FROM read_fastx(['data/fastq/small_a.fq', 'data/fastq/small_b.fq', 'data/fastq/small_c.fq'])
----
5

# Test parallel execution (set preserve_insertion_order=false)
statement ok
SET preserve_insertion_order=false;

query I
SELECT COUNT(*) FROM read_fastx(['data/fastq/foo.r1.fastq.gz', 'data/fastq/bar.r1.fastq.gz'])
----
5

statement ok
SET preserve_insertion_order=true;

# Error: empty file should throw
statement error
SELECT * FROM read_fastx('data/fastq/empty.fq');
----
Invalid Error: Empty file

# Error: mismatched array lengths
statement error
SELECT * FROM read_fastx(['data/fastq/small_a.fq', 'data/fastq/small_b.fq'], 
                          sequence2=['data/fastq/small_a_r2.fq']);
----
Invalid Input Error: Mismatched array lengths

# Error: stdin with sequence2
statement error
SELECT * FROM read_fastx('-', sequence2='data/fastq/small_a_r2.fq');
----
Invalid Input Error: stdin cannot be used with sequence2

# Error: stdin with VARCHAR[]
statement error
SELECT * FROM read_fastx(['-', 'data/fastq/small_a.fq']);
----
Invalid Input Error: stdin

# Error: mixed FASTA/FASTQ paired-end
statement error
SELECT * FROM read_fastx('data/fastq/test_r1.fa', sequence2='data/fastq/test_r2.fq');
----
Invalid Error: Cannot mix FASTA and FASTQ formats
